#!/bin/bash

# Git Monkey v4 - Main CLI Router
# Copyright (c) 2025 Pablo Alvarado
# See LICENSE file for terms

# Load utilities
source ./utils/command_tracker.sh
source ./utils/profile.sh
source ./utils/identity.sh
source ./utils/performance.sh

COMMAND=$1
shift

# Get user profile information
TONE_STAGE=$(get_tone_stage)
THEME=$(get_selected_theme)
IDENTITY=$(get_full_identity)

# Check if this is the first run
FIRST_RUN=false
if [ ! -f "$HOME/.gitmonkey/welcomed" ]; then
  FIRST_RUN=true
fi

# Show welcome screen on first run or when explicitly requested
if [ "$FIRST_RUN" = true ] && [ "$COMMAND" != "welcome" ]; then
  # First time running Git Monkey, show welcome
  ./commands/welcome.sh
  # If no command specified, exit after welcome (otherwise continue to requested command)
  if [ -z "$COMMAND" ]; then
    exit 0
  fi
elif [ "$COMMAND" = "welcome" ]; then
  # Explicitly requested welcome
  ./commands/welcome.sh --reset
  exit 0
fi

# Show greeting for direct command invocation (not help/version/welcome)
if [ -n "$COMMAND" ] && [ "$COMMAND" != "help" ] && [ "$COMMAND" != "version" ] && [ "$COMMAND" != "welcome" ]; then
  # Use our improved greeting system that's identity and theme aware
  show_greeting
  
  # Track the command execution for tone stage advancement
  if [ "$COMMAND" != "settings" ] && [ "$COMMAND" != "identity" ] && [ "$COMMAND" != "title" ]; then
    increment_command_usage "$COMMAND"
  fi
fi

case "$COMMAND" in
  welcome)
    ./commands/welcome.sh "$@"
    ;;
  alias)
    ./commands/alias.sh "$@"
    ;;
  clone)
    ./commands/clone.sh "$@"
    ;;
  branch)
    ./commands/branch.sh "$@"
    ;;
  stash)
    ./commands/stash.sh "$@"
    ;;
  push)
    ./commands/push.sh "$@"
    ;;
  undo)
    ./commands/undo.sh "$@"
    ;;
  tips)
    ./commands/tips.sh "$@"
    ;;
  learn)
    ./commands/learn.sh "$@"
    ;;
  tutorial|school)
    ./commands/tutorial.sh "$@"
    ;;
  worktree|worktree:*)
    ./commands/worktree.sh "$@"
    ;;
  generate)
    ./commands/generate.sh "$@"
    ;;
  open)
    ./commands/open.sh "$@"
    ;;
  fix)
    ./commands/fix.sh "$@"
    ;;
  conflict|resolve)
    ./commands/conflict.sh "$@"
    ;;
  history|log)
    ./commands/history.sh "$@"
    ;;
  cheatsheet|cheat|reference)
    ./commands/cheatsheet.sh "$@"
    ;;
  pivot)
    # For pivot, we need to evaluate the output to change directory
    eval "$(./commands/pivot.sh "$@")"
    ;;
  return)
    # For return, we need to evaluate the output to change directory
    eval "$(./commands/return.sh "$@")"
    ;;
  whoami)
    ./commands/whoami.sh "$@"
    ;;
  title)
    ./commands/title.sh "$@"
    ;;
  identity)
    ./commands/identity.sh "$@"
    ;;
  wizard)
    ./commands/wizard.sh "$@"
    ;;
  settings)
    ./commands/settings.sh "$@"
    ;;
  version)
    echo "Git Monkey v4.1"
    ;;
  help)
    # Use our new help command
    ./commands/help.sh "$@"
    ;;
  --help|-h)
    # Route legacy help flags to help command
    ./commands/help.sh "$@"
    ;;
  legacy-help)
    echo "üêí Git Monkey CLI - The chillest way to Git"
    echo ""
    echo "Available commands:"
    echo "  gitmonkey welcome    - Run the welcome and onboarding experience"
    echo "  gitmonkey alias      - Install helpful Git aliases"
    echo "  gitmonkey clone      - Clone a repository with guidance"
    echo "  gitmonkey branch     - Create or manage branches"
    echo "  gitmonkey stash      - Stash your changes for later"
    echo "  gitmonkey push       - Push with automatic upstream tracking"
    echo "  gitmonkey undo       - Undo mistakes safely"
    echo "  gitmonkey worktree   - Work on multiple branches at once (try this!)"
    echo "  gitmonkey pivot      - Quick context switching with auto-stashing"
    echo "  gitmonkey return     - Return to previous context"
    echo "  gitmonkey whoami     - Show your current Git context"
    echo "  gitmonkey title      - View and manage your Git Monkey titles"
    echo "  gitmonkey identity   - Configure your personalized identity"
    echo "  gitmonkey generate   - Generate code and components"
    echo "  gitmonkey open       - Open projects in your preferred editor"
    echo "  gitmonkey fix        - Fix common development issues"
    echo "  gitmonkey conflict   - Interactive merge conflict resolution"
    echo "  gitmonkey history    - Visualize and navigate Git history"
    echo "  gitmonkey cheatsheet - Quick reference for Git commands"
    echo "  gitmonkey learn      - Learn Git concepts and Git Monkey features"
    echo "  gitmonkey tutorial   - Interactive Git tutorials"
    echo "  gitmonkey tips       - Show helpful Git tips"
    echo "  gitmonkey wizard     - Access advanced Git features"
    echo "  gitmonkey settings   - Customize your Git Monkey experience"
    echo "  gitmonkey version    - Show current version"
    echo "  gitmonkey help       - Show this help message"
    echo ""
    echo "Running without a command opens the interactive menu."
    echo ""
    echo "üí° Try: gitmonkey worktree:add <branch> to start using worktrees!"
    ;;
  *)
    ./commands/menu.sh
    ;;
esac

